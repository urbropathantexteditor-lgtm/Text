<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Group Chat — Clocktower Theme</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:url('https://images.unsplash.com/photo-1570129477492-45c003edd2be?auto=format&fit=crop&w=1470&q=80') no-repeat center/cover;color:white;display:flex;justify-content:center;align-items:center;height:100vh}
  .app{width:100%;max-width:500px;background:rgba(0,0,0,0.6);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;height:80vh}
  .header{background:rgba(0,0,0,0.8);padding:12px;text-align:center;font-size:18px;font-weight:bold;position:relative}
  .closeChat{position:absolute;right:12px;top:12px;cursor:pointer;font-size:18px}  
  .chatArea{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;}
  .msg{padding:10px;border-radius:10px;max-width:80%;display:flex;gap:8px;align-items:flex-start}
  .msg.user{align-self:flex-end;background:rgba(16,185,129,0.8);}
  .msg.other{align-self:flex-start;background:rgba(30,41,59,0.8);}
  .msg img.pfp{width:32px;height:32px;border-radius:50%;object-fit:cover}
  .msgContent{display:flex;flex-direction:column;}
  .username{font-size:12px;color:#94a3b8}
  .text{font-size:16px}
  .inputArea{display:flex;gap:8px;padding:8px;background:rgba(0,0,0,0.7)}
  .inputArea input{flex:1;padding:8px;border-radius:8px;border:none}
  .inputArea button{padding:8px 12px;border:none;border-radius:8px;background:#10b981;color:#06201b;cursor:pointer}
  .hidden{display:none}
  .typing{font-size:12px;color:#94a3b8;animation:blink 1s infinite}
  @keyframes blink{0%,50%,100%{opacity:0}25%,75%{opacity:1}}
  .loginArea{display:flex;flex-direction:column;gap:8px;padding:12px}
  .loginArea input{padding:8px;border-radius:8px;border:none}
  .profileSetup{display:flex;flex-direction:column;gap:8px;padding:12px}
</style>
</head>
<body>
<div class="app" id="app">  <!-- Login -->  <div id="loginDiv" class="loginArea">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login / Register</button>
    <div id="loginMsg"></div>
  </div>  <!-- Profile Setup -->  <div id="profileDiv" class="profileSetup hidden">
    <h2>Set Profile</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="file" id="pfp" accept="image/*">
    <button id="saveProfile">Save Profile</button>
  </div>  <!-- Chat -->  <div id="chatDiv" class="hidden" style="flex:1;display:flex;flex-direction:column">
    <div class="header">General Chat <span class="closeChat" id="closeChat">⮐</span></div>
    <div class="chatArea" id="chatArea"></div>
    <div class="inputArea">
      <input type="text" id="msgInput" placeholder="Type a message">
      <input type="file" id="photoInput" accept="image/*">
      <button id="sendBtn">Send</button>
    </div>
    <div class="typing" id="typingIndicator" style="display:none">Someone is typing...</div>
  </div></div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded, set, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginDiv = document.getElementById('loginDiv');
const profileDiv = document.getElementById('profileDiv');
const chatDiv = document.getElementById('chatDiv');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const saveProfile = document.getElementById('saveProfile');
const chatArea = document.getElementById('chatArea');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const usernameInput = document.getElementById('username');
const pfpInput = document.getElementById('pfp');
const typingIndicator = document.getElementById('typingIndicator');
const closeChat = document.getElementById('closeChat');
const photoInput = document.getElementById('photoInput');

let currentUser = null;

loginBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  if(!email||!pass){ loginMsg.textContent='Enter email & password'; return; }
  try{
    let user;
    try{ user = await signInWithEmailAndPassword(auth,email,pass); } catch(e){ user = await createUserWithEmailAndPassword(auth,email,pass); }
  }catch(err){ loginMsg.textContent = 'Login failed: '+err.message; }
});

saveProfile.addEventListener('click', async ()=>{
  const uname = usernameInput.value.trim();
  const file = pfpInput.files[0];
  if(!uname||!file){ alert('Enter username & choose profile pic'); return; }
  const reader = new FileReader();
  reader.onload = async ()=>{
    const pfpBase64 = reader.result;
    await update(ref(db,'users/'+currentUser.uid),{username:uname,pfp:pfpBase64});
    profileDiv.classList.add('hidden');
    chatDiv.classList.remove('hidden');
    startChat();
  };
  reader.readAsDataURL(file);
});

function startChat(){
  const messagesRef = ref(db,'messages');
  onChildAdded(messagesRef,(snap)=>{
    const msg = snap.val();
    const div = document.createElement('div');
    div.className='msg '+(msg.uid===currentUser.uid?'user':'other');
    let content='';
    if(msg.photo){ content=`<img src='${msg.photo}' style='max-width:150px;border-radius:8px'>`; }
    if(msg.text){ content+=`<div class='text'>${msg.text}</div>`; }
    div.innerHTML=`<img class='pfp' src='${msg.pfp}'><div class='msgContent'><div class='username'>${msg.username}</div>${content}</div>`;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  });

  msgInput.addEventListener('input',()=>{typingIndicator.style.display='block';setTimeout(()=>typingIndicator.style.display='none',1000);});

  sendBtn.addEventListener('click', async ()=>{
    const text = msgInput.value.trim();
    const file = photoInput.files[0];
    if(!text&&!file) return;
    let photo=null;
    if(file){
      const reader = new FileReader();
      reader.onload= async ()=>{
        photo = reader.result;
        await push(ref(db,'messages'),{uid:currentUser.uid,username:currentUser.displayName,pfp:currentUser.photoURL,text,photo});
        msgInput.value=''; photoInput.value='';
      };
      reader.readAsDataURL(file);
    }else{
      await push(ref(db,'messages'),{uid:currentUser.uid,username:currentUser.displayName,pfp:currentUser.photoURL,text});
      msgInput.value='';
    }
  });
}

closeChat.addEventListener('click',()=>{ chatDiv.classList.add('hidden'); });

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    loginDiv.classList.add('hidden');
    get(ref(db,'users/'+user.uid)).then(snap=>{
      if(snap.exists()&&snap.val().username&&snap.val().pfp){
        chatDiv.classList.remove('hidden');
        startChat();
      }else{
        profileDiv.classList.remove('hidden');
      }
    });
  }else{
    loginDiv.classList.remove('hidden');
  }
});
</script></body>
</html>

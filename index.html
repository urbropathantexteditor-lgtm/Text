<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ur Bro â€” Group Chat</title>
<style>
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --accent: #10b981;
    --text: #f1f5f9;
    --muted: #94a3b8;
    --input-bg: #172033;
  }
  body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--text); }
  .center { display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; }
  .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:var(--accent); color:#000; font-weight:600; margin:6px; }
  .card { background:var(--card); border-radius:12px; padding:16px; margin:12px; width:90%; max-width:500px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
  input, textarea { width:100%; padding:10px; margin:6px 0; border:none; border-radius:8px; background:var(--input-bg); color:var(--text); }
  .chat-container { display:flex; flex-direction:column; height:80vh; overflow-y:auto; gap:8px; padding:8px; background:var(--card); border-radius:12px; }
  .message { display:flex; gap:8px; align-items:flex-start; }
  .msg-content { background:var(--accent); padding:8px 12px; border-radius:12px; max-width:70%; word-break:break-word; color:#000; position:relative; animation:fadeIn 0.3s; }
  .msg-user { font-size:12px; color:var(--muted); }
  .pfp { width:32px; height:32px; border-radius:50%; object-fit:cover; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:10px 16px; border-bottom:1px solid rgba(255,255,255,0.1); }
  .typing { font-size:12px; color:var(--muted); font-style:italic; }
  .hidden { display:none; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body>
<div id="loginDiv" class="center card">
  <h2>Login Required</h2>
  <button id="googleLogin" class="btn">Login with Google</button>
</div>

<div id="profileDiv" class="center card hidden">
  <h2>Set Profile</h2>
  <input type="text" id="username" placeholder="Enter Username">
  <input type="file" id="pfpInput" accept="image/*">
  <button id="saveProfile" class="btn">Save Profile</button>
</div>

<div id="chatDiv" class="hidden">
  <div class="top-bar">
    <div>Ur Bro Group Chat</div>
    <div><button id="logoutBtn" class="btn">Logout</button></div>
  </div>
  <div class="chat-container" id="chatContainer"></div>
  <div style="padding:10px; display:flex; gap:6px;">
    <input type="text" id="chatMsg" placeholder="Type message...">
    <input type="file" id="chatPhoto" accept="image/*">
    <button id="sendBtn" class="btn">Send</button>
  </div>
  <div id="typingIndicator" class="typing hidden">Someone is typing...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onChildAdded, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// ------------------- Replace with your Firebase config -------------------
const firebaseConfig = {
  apiKey: "AIzaSyDFPMf8HLMpS6DbZkdCR6T7GAm5sfz-TOw",
  authDomain: "urbrokhan-f631c.firebaseapp.com",
  databaseURL: "https://urbrokhan-f631c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urbrokhan-f631c",
  storageBucket: "urbrokhan-f631c.appspot.com",
  messagingSenderId: "533086015351",
  appId: "1:533086015351:web:a12328fbc4906e4f5c9b72",
  measurementId: "G-TGT66KJV02"
};

// ------------------- Firebase init -------------------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

// ------------------- Elements -------------------
const loginDiv = document.getElementById('loginDiv');
const profileDiv = document.getElementById('profileDiv');
const chatDiv = document.getElementById('chatDiv');
const googleLogin = document.getElementById('googleLogin');
const logoutBtn = document.getElementById('logoutBtn');
const usernameInput = document.getElementById('username');
const pfpInput = document.getElementById('pfpInput');
const saveProfile = document.getElementById('saveProfile');
const chatContainer = document.getElementById('chatContainer');
const chatMsg = document.getElementById('chatMsg');
const chatPhoto = document.getElementById('chatPhoto');
const sendBtn = document.getElementById('sendBtn');
const typingIndicator = document.getElementById('typingIndicator');

let currentUser = null;
let currentUserData = null;

// ------------------- Auth Flow -------------------
googleLogin.addEventListener('click', async () => {
  try { await signInWithPopup(auth, provider); } 
  catch(e){ alert("Login failed"); console.error(e); }
});

logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
});

// ------------------- Profile Check -------------------
async function checkProfile(uid){
  const snap = await get(ref(db,'users/'+uid));
  if(snap.exists() && snap.val().username){
    currentUserData = snap.val();
    showChat();
  } else {
    showProfile();
  }
}

// ------------------- Display Divs -------------------
function showLogin(){ loginDiv.classList.remove('hidden'); profileDiv.classList.add('hidden'); chatDiv.classList.add('hidden'); }
function showProfile(){ loginDiv.classList.add('hidden'); profileDiv.classList.remove('hidden'); chatDiv.classList.add('hidden'); }
function showChat(){ loginDiv.classList.add('hidden'); profileDiv.classList.add('hidden'); chatDiv.classList.remove('hidden'); loadMessages(); }

// ------------------- Save Profile -------------------
saveProfile.addEventListener('click', async ()=>{
  const uname = usernameInput.value.trim();
  if(!uname){ alert("Enter username"); return; }
  let pfpURL = "";
  if(pfpInput.files.length>0){
    const file = pfpInput.files[0];
    pfpURL = await new Promise((res)=>{
      const reader = new FileReader();
      reader.onload = e=>res(e.target.result);
      reader.readAsDataURL(file);
    });
  }
  await set(ref(db,'users/'+currentUser.uid), {username:uname, pfp:pfpURL});
  currentUserData = {username:uname, pfp:pfpURL};
  showChat();
});

// ------------------- On Auth Change -------------------
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    loginDiv.classList.add('hidden');
    await checkProfile(user.uid);
  } else {
    showLogin();
  }
});

// ------------------- Chat -------------------
sendBtn.addEventListener('click', async ()=>{
  const text = chatMsg.value.trim();
  let photo = null;
  if(chatPhoto.files.length>0){
    const file = chatPhoto.files[0];
    photo = await new Promise((res)=>{
      const reader = new FileReader();
      reader.onload = e=>res(e.target.result);
      reader.readAsDataURL(file);
    });
    chatPhoto.value="";
  }
  if(!text && !photo){ return; }
  await push(ref(db,'messages'), {
    uid:currentUser.uid,
    username: currentUserData.username,
    pfp: currentUserData.pfp||"",
    text: text||"",
    photo: photo||"",
    timestamp: Date.now()
  });
  chatMsg.value="";
});

// ------------------- Load Messages -------------------
function loadMessages(){
  chatContainer.innerHTML="";
  const msgRef = ref(db,'messages');
  onChildAdded(msgRef, snapshot=>{
    const msg = snapshot.val();
    const div = document.createElement('div');
    div.className='message';
    div.innerHTML = `
      <img class="pfp" src="${msg.pfp||'https://via.placeholder.com/32'}">
      <div>
        <div class="msg-user">${msg.username}</div>
        <div class="msg-content">${msg.text}${msg.photo?'<br><img src="'+msg.photo+'" style="max-width:200px; border-radius:12px;">':''}</div>
      </div>
    `;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });
}

// ------------------- Typing Indicator (Simple) -------------------
let typingTimeout;
chatMsg.addEventListener('input', ()=>{
  const typingRef = ref(db,'typing/'+currentUser.uid);
  set(typingRef,true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=> set(typingRef,false),1500);
});
const typingRef = ref(db,'typing');
onChildAdded(typingRef, snap=>{
  if(snap.key!==currentUser?.uid && snap.val()){
    typingIndicator.classList.remove('hidden');
    setTimeout(()=>typingIndicator.classList.add('hidden'),2000);
  }
});

</script>
</body>
</html>

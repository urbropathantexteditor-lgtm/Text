<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ur Bro â€” Group Chat</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  body{margin:0;font-family:'Inter',sans-serif;background:url('https://images.unsplash.com/photo-1603063747545-4f0d1c8f7b70?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8Y2xvY2t0b3dlcnx8fHx8fDE2OTY2OTk3OTU&ixlib=rb-4.0.3&q=80&w=1080') no-repeat center center fixed;background-size:cover;color:#fff;display:flex;justify-content:center;align-items:flex-start;padding:0;}
  .chat-app{width:100%;max-width:600px;margin-top:40px;background:rgba(0,0,0,0.6);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:80vh;}
  .header{background:rgba(0,0,0,0.7);padding:12px;display:flex;justify-content:space-between;align-items:center;}
  .header h2{margin:0;font-weight:600;}
  .user-list-btn{cursor:pointer;background:#10b981;padding:6px 10px;border:none;border-radius:6px;font-weight:600;}
  #userListPanel{position:fixed;top:0;right:-300px;width:280px;height:100%;background:rgba(0,0,0,0.9);transition:0.3s;padding:12px;overflow-y:auto;z-index:1000;}
  #userListPanel.show{right:0;}
  .user-item{display:flex;align-items:center;margin-bottom:8px;}
  .user-item img{width:30px;height:30px;border-radius:50%;margin-right:8px;}
  .chat-messages{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;}
  .message{margin-bottom:12px;animation:fadeIn 0.5s ease;}
  .message .meta{font-size:12px;color:#aaa;}
  .message .text{font-size:16px;margin-top:2px;}
  .message img{max-width:200px;border-radius:8px;margin-top:4px;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .typing-indicator{font-size:12px;color:#aaa;font-style:italic;margin-bottom:8px;}
  .input-panel{display:flex;gap:6px;padding:10px;background:rgba(0,0,0,0.7);}
  .input-panel input[type="text"]{flex:1;padding:8px;border-radius:6px;border:none;background:#1a1a1a;color:#fff;}
  .input-panel input[type="file"]{display:none;}
  .input-panel button{background:#10b981;padding:6px 10px;border:none;border-radius:6px;color:#000;font-weight:600;cursor:pointer;}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:2000;}
  .overlay-content{background:#071025;padding:20px;border-radius:12px;width:90%;max-width:360px;text-align:center;}
  .overlay-content input{width:100%;padding:8px;margin:8px 0;border-radius:6px;border:none;}
  .overlay-content img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:8px;}
</style>
</head>
<body>

<div class="chat-app" id="chatApp">
  <div class="header">
    <h2>Ur Bro â€” Group Chat</h2>
    <button class="user-list-btn" id="showUsersBtn">Users</button>
  </div>
  <div class="chat-messages" id="messages"></div>
  <div class="typing-indicator" id="typingIndicator"></div>
  <div class="input-panel">
    <input type="text" id="msgInput" placeholder="Type a message...">
    <input type="file" id="photoInput" accept="image/*">
    <button id="sendPhotoBtn">ðŸ“·</button>
    <button id="sendBtn">Send</button>
  </div>
</div>

<div id="userListPanel">
  <h3>Active Users</h3>
  <div id="userList"></div>
</div>

<div class="overlay" id="loginOverlay">
  <div class="overlay-content">
    <h3>Login & Set Profile</h3>
    <button id="googleLoginBtn">Login with Google</button>
    <div id="profileSetup" style="display:none;">
      <img id="pfpPreview" src="" alt="Profile Picture">
      <input type="text" id="usernameInput" placeholder="Choose a username">
      <input type="file" id="pfpInput" accept="image/*">
      <button id="saveProfileBtn">Save Profile</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFPMf8HLMpS6DbZkdCR6T7GAm5sfz-TOw",
  authDomain: "urbrokhan-f631c.firebaseapp.com",
  databaseURL: "https://urbrokhan-f631c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urbrokhan-f631c",
  storageBucket: "urbrokhan-f631c.appspot.com",
  messagingSenderId: "533086015351",
  appId: "1:533086015351:web:a12328fbc4906e4f5c9b72"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

/* ---------------- Elements ---------------- */
const loginOverlay = document.getElementById('loginOverlay');
const googleLoginBtn = document.getElementById('googleLoginBtn');
const profileSetup = document.getElementById('profileSetup');
const pfpInput = document.getElementById('pfpInput');
const pfpPreview = document.getElementById('pfpPreview');
const usernameInput = document.getElementById('usernameInput');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const messagesEl = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const photoInput = document.getElementById('photoInput');
const sendPhotoBtn = document.getElementById('sendPhotoBtn');
const typingIndicator = document.getElementById('typingIndicator');
const showUsersBtn = document.getElementById('showUsersBtn');
const userListPanel = document.getElementById('userListPanel');
const userListEl = document.getElementById('userList');

let currentUser = null;
let currentUid = null;
let currentData = null;
let typingTimeout = null;

/* ---------------- Auth & Profile ---------------- */
googleLoginBtn.onclick = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
  } catch(err){ console.error(err); alert('Login failed'); }
};

onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    currentUid = user.uid;
    // check if profile exists
    const snap = await get(ref(db,'users/'+currentUid));
    if(!snap.exists() || !snap.val().username || !snap.val().pfp){
      loginOverlay.style.display='flex';
      profileSetup.style.display='block';
    } else {
      currentData = snap.val();
      loginOverlay.style.display='none';
      initChat();
    }
  } else {
    currentUser = null;
    currentUid = null;
    currentData = null;
    loginOverlay.style.display='flex';
    profileSetup.style.display='none';
  }
});

pfpInput.onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { pfpPreview.src = reader.result; }
  reader.readAsDataURL(file);
};

saveProfileBtn.onclick = async () => {
  const uname = usernameInput.value.trim();
  const pfp = pfpPreview.src;
  if(!uname || !pfp){ alert('Set username and profile picture'); return; }
  await set(ref(db,'users/'+currentUid),{username:uname,pfp:pfp});
  currentData = {username:uname,pfp:pfp};
  loginOverlay.style.display='none';
  initChat();
};

/* ---------------- Chat ---------------- */
function initChat(){
  // display messages in real-time
  const msgRef = ref(db,'messages');
  onValue(msgRef,snap=>{
    messagesEl.innerHTML='';
    snap.forEach(child=>{
      const m = child.val();
      const div = document.createElement('div');
      div.className='message';
      div.innerHTML=`<div class="meta"><img src="${m.pfp}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:4px">${m.username}</div><div class="text">${m.text || ''}${m.photo ? '<br><img src="'+m.photo+'">' : ''}</div>`;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  // typing indicator
  msgInput.addEventListener('input',()=>{
    const typingRef = ref(db,'typing/'+currentUid);
    set(typingRef,{username:currentData.username});
    if(typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{ set(typingRef,null); },1000);
  });

  // show who is typing
  const typingRefAll = ref(db,'typing');
  onValue(typingRefAll,snap=>{
    let names = [];
    snap.forEach(child=>{ if(child.key !== currentUid) names.push(child.val().username); });
    typingIndicator.textContent = names.length ? names.join(', ')+' is typing...' : '';
  });

  sendBtn.onclick = sendMessage;
  sendPhotoBtn.onclick = ()=> photoInput.click();
  photoInput.onchange = async e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      await push(ref(db,'messages'),{username:currentData.username,pfp:currentData.pfp,photo:reader.result,timestamp:Date.now()});
      photoInput.value='';
    };
    reader.readAsDataURL(file);
  };
}

function sendMessage(){
  const txt = msgInput.value.trim();
  if(!txt) return;
  push(ref(db,'messages'),{username:currentData.username,pfp:currentData.pfp,text:txt,timestamp:Date.now()});
  msgInput.value='';
}

/* ---------------- User List ---------------- */
showUsersBtn.onclick = ()=>{
  userListPanel.classList.toggle('show');
};
const usersRef = ref(db,'users');
onValue(usersRef,snap=>{
  userListEl.innerHTML='';
  let total=0;
  snap.forEach(child=>{
    const u = child.val();
    if(u.username && u.pfp){
      total++;
      const div = document.createElement('div');
      div.className='user-item';
      div.innerHTML=`<img src="${u.pfp}"><span>${u.username}</span>`;
      userListEl.appendChild(div);
    }
  });
});

</script>
</body>
</html>

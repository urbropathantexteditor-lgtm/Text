<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ur Bro â€” Group Chat</title>
<style>
:root {
  --bg:#0b0c10; --card:#1f2833; --accent:#66fcf1; --text:#c5c6c7; --small:#45a29e;
}
body,html{margin:0;padding:0;width:100%;height:100%;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;font-family:sans-serif;}
.app{width:100%;max-width:500px;height:100%;display:flex;flex-direction:column;position:relative;}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%;padding:20px;}
.screen.active{display:flex;}
.btn{background:var(--accent);color:var(--bg);padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin-top:10px;}
.inputField{width:100%;padding:10px;border-radius:8px;border:none;margin:6px 0;background:#1c1f24;color:#fff;}
.chatContainer{flex:1;width:100%;overflow-y:auto;display:flex;flex-direction:column;padding-bottom:10px;}
.message{display:flex;gap:10px;margin:6px 0;align-items:flex-end;}
.message.self{flex-direction:row-reverse;}
.msgContent{max-width:70%;padding:8px 12px;border-radius:12px;background:var(--card);word-break:break-word;}
.msgContent img{max-width:200px;border-radius:10px;}
.msgUser{font-size:12px;color: var(--small);margin-bottom:2px;text-align:left;}
.msgUser.self{text-align:right;}
.inputArea{display:flex;gap:6px;width:100%;margin-top:6px;}
.pfpPreview{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.typingIndicator{font-size:12px;color:var(--small);margin:4px 0 0 50px;}
</style>
</head>
<body>
<div class="app">
  <!-- LOGIN -->
  <div class="screen active" id="loginScreen">
    <h2>Login to Chat</h2>
    <button class="btn" id="loginBtn">Login with Google</button>
  </div>

  <!-- PROFILE SETUP -->
  <div class="screen" id="profileScreen">
    <h2>Set Your Profile</h2>
    <input type="text" id="username" class="inputField" placeholder="Enter username">
    <input type="file" id="pfpInput" accept="image/*">
    <img id="pfpPreview" class="pfpPreview" style="display:none;margin-top:10px">
    <button class="btn" id="saveProfile">Save Profile</button>
  </div>

  <!-- CHAT SCREEN -->
  <div class="screen" id="chatScreen">
    <div class="chatContainer" id="chatContainer"></div>
    <div class="typingIndicator" id="typingIndicator" style="display:none">Someone is typing...</div>
    <div class="inputArea">
      <input type="text" id="chatInput" class="inputField" placeholder="Type a message">
      <input type="file" id="imageInput" accept="image/*">
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

// ----------- YOUR FIREBASE CONFIG -----------
const firebaseConfig = {
  apiKey: "AIzaSyDFPMf8HLMpS6DbZkdCR6T7GAm5sfz-TOw",
  authDomain: "urbrokhan-f631c.firebaseapp.com",
  databaseURL: "https://urbrokhan-f631c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urbrokhan-f631c",
  storageBucket: "urbrokhan-f631c.appspot.com",
  messagingSenderId: "533086015351",
  appId: "1:533086015351:web:a12328fbc4906e4f5c9b72",
  measurementId: "G-TGT66KJV02"
};

// ----------- INIT -----------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

// ----------- ELEMENTS -----------
const loginScreen = document.getElementById('loginScreen');
const profileScreen = document.getElementById('profileScreen');
const chatScreen = document.getElementById('chatScreen');
const loginBtn = document.getElementById('loginBtn');
const saveProfileBtn = document.getElementById('saveProfile');
const usernameInput = document.getElementById('username');
const pfpInput = document.getElementById('pfpInput');
const pfpPreview = document.getElementById('pfpPreview');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const chatContainer = document.getElementById('chatContainer');
const imageInput = document.getElementById('imageInput');
const typingIndicator = document.getElementById('typingIndicator');

let currentUser = null;
let profileData = null;

// ----------- AUTH -----------
loginBtn.onclick = async () => {
  await signInWithPopup(auth, provider);
};

onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    const snap = await get(ref(db,'profiles/'+user.uid));
    if(!snap.exists()){
      loginScreen.classList.remove('active');
      profileScreen.classList.add('active');
    } else {
      profileData = snap.val();
      loginScreen.classList.remove('active');
      chatScreen.classList.add('active');
      loadChat();
    }
  } else {
    loginScreen.classList.add('active');
    profileScreen.classList.remove('active');
    chatScreen.classList.remove('active');
  }
});

// ----------- PROFILE SETUP -----------
pfpInput.onchange = ()=>{
  const file = pfpInput.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (e)=>{ pfpPreview.src = e.target.result; pfpPreview.style.display='block'; }
    reader.readAsDataURL(file);
  }
};

saveProfileBtn.onclick = async ()=>{
  const uname = usernameInput.value.trim();
  if(!uname){ alert('Enter username'); return; }
  let pfpUrl = '';
  if(pfpInput.files[0]){
    const file = pfpInput.files[0];
    const storageRef = sRef(storage,'pfp/'+currentUser.uid);
    await uploadBytes(storageRef,file);
    pfpUrl = await getDownloadURL(storageRef);
  }
  await set(ref(db,'profiles/'+currentUser.uid),{ username:uname, pfp: pfpUrl });
  profileData = { username:uname, pfp: pfpUrl };
  profileScreen.classList.remove('active');
  chatScreen.classList.add('active');
  loadChat();
};

// ----------- CHAT -----------
function createMessageEl(msg){
  const div = document.createElement('div');
  div.className = 'message '+(msg.uid===currentUser.uid?'self':'');
  const userDiv = document.createElement('div');
  userDiv.className = 'msgUser '+(msg.uid===currentUser.uid?'self':'');
  userDiv.textContent = msg.username;
  const contentDiv = document.createElement('div');
  contentDiv.className='msgContent';
  if(msg.type==='text') contentDiv.textContent = msg.message;
  else if(msg.type==='image'){
    const img = document.createElement('img');
    img.src = msg.message;
    contentDiv.appendChild(img);
  }
  div.appendChild(userDiv);
  div.appendChild(contentDiv);
  return div;
}

function loadChat(){
  const chatRef = ref(db,'messages');
  onChildAdded(chatRef,(snap)=>{
    const msg = snap.val();
    const msgEl = createMessageEl(msg);
    chatContainer.appendChild(msgEl);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });
}

// ----------- SEND MESSAGE -----------
sendBtn.onclick = async ()=>{
  const txt = chatInput.value.trim();
  if(!txt && !imageInput.files[0]) return;
  let msgType='text';
  let msgContent = txt;
  if(imageInput.files[0]){
    const file = imageInput.files[0];
    const storageRef = sRef(storage,'chatImages/'+Date.now());
    await uploadBytes(storageRef,file);
    msgContent = await getDownloadURL(storageRef);
    msgType='image';
  }
  chatInput.value='';
  imageInput.value='';
  await push(ref(db,'messages'),{
    uid: currentUser.uid,
    username: profileData.username,
    pfp: profileData.pfp||'',
    type: msgType,
    message: msgContent,
    timestamp: Date.now()
  });
};
</script>
</body>
</html>

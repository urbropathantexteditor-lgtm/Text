<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ur bro pathan â€” Stylish Text Generator (Auth + Coins + Referral)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#10b981; --glass:#1e293b;
  }
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#f1f5f9;display:flex;justify-content:center;padding:18px}
  .app{width:100%;max-width:1100px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{background:var(--accent);color:#06201b;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px}
  .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  textarea{width:100%;min-height:84px;padding:12px;border-radius:8px;background:var(--glass);border:none;color:white;font-size:16px;resize:vertical}
  .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .chip{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;color:var(--muted);font-weight:600}
  .small{font-size:13px;color:var(--muted)}
  .styles{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;max-height:60vh;overflow:auto;padding:6px}
  .style{background:var(--glass);padding:10px;border-radius:10px;cursor:pointer;text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center;word-break:break-word;transition:transform .12s,background .12s}
  .style:hover{transform:translateY(-4px);background:#263247}
  .coin{font-weight:700;color:var(--accent)}
  .refBox{display:flex;gap:8px;align-items:center}
  .input{background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 10px;border:none;color:white}
  .muted{color:var(--muted)}
  .wa-btn{position:fixed;right:18px;bottom:18px;background:#25D366;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.4);z-index:1000}
  @media (max-width:600px){header{flex-direction:column;align-items:flex-start;gap:8px}.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">PB</div>
        <div>
          <h1>ur bro pathan â€” Stylish Text Generator</h1>
          <div class="small muted">Login required â€¢ 2 coins per copy â€¢ referral rewards</div>
        </div>
      </div>

      <div class="controls">
        <div id="userArea" style="display:flex;gap:8px;align-items:center">
          <div id="coinDisplay" class="chip">Coins: <span class="coin">0</span></div>
          <div id="userName" class="small muted"></div>
          <button id="loginBtn" class="btn">Login with Google</button>
          <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
        </div>
      </div>
    </header>

    <!-- top controls: referral -->
    <div class="card row">
      <div class="col">
        <div class="small muted">Your referral code (share with friends):</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div id="myRefCode" class="chip">â€”</div>
          <button id="copyRefBtn" class="btn ghost" style="display:none">Copy</button>
          <div id="referredCount" class="small muted">Referred: 0</div>
        </div>
      </div>

      <div style="min-width:260px">
        <div class="small muted">Apply referral code (if you have one):</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="applyRefInput" class="input" placeholder="Enter referral code" />
          <button id="applyRefBtn" class="btn">Apply</button>
        </div>
        <div id="applyMsg" class="small muted" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Text area + generator -->
    <div class="card">
      <div class="meta">
        <div class="small muted">Type text:</div>
        <div class="chip" id="statusHint">You must be logged in to copy (2 coins per copy)</div>
      </div>
      <textarea id="input" placeholder="Type your text here...">Hello from ur bro pathan</textarea>
    </div>

    <div class="card">
      <div class="small muted" style="margin-bottom:8px">Tap a style to copy (cost: 2 coins)</div>
      <div class="styles" id="stylesList"></div>
    </div>

    <div class="small muted" style="margin-top:4px">Admin note: You can seed coins by updating the user's `coins` value in the Realtime Database at `/users/{uid}/coins`.</div>
  </div>

  <a class="wa-btn" href="https://wa.me/447877486623" target="_blank" title="Chat on WhatsApp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA" style="width:30px;height:30px">
  </a>

<script type="module">
/* ------------- Firebase setup (you provided these credentials) ------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, get, set, update, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFPMf8HLMpS6DbZkdCR6T7GAm5sfz-TOw",
  authDomain: "urbrokhan-f631c.firebaseapp.com",
  databaseURL: "https://urbrokhan-f631c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urbrokhan-f631c",
  storageBucket: "urbrokhan-f631c.firebasestorage.app",
  messagingSenderId: "533086015351",
  appId: "1:533086015351:web:a12328fbc4906e4f5c9b72",
  measurementId: "G-TGT66KJV02"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

/* ----------------- DOM elements ----------------- */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const coinDisplay = document.querySelector('#coinDisplay .coin');
const userNameEl = document.getElementById('userName');
const myRefCodeEl = document.getElementById('myRefCode');
const copyRefBtn = document.getElementById('copyRefBtn');
const referredCountEl = document.getElementById('referredCount');
const applyRefInput = document.getElementById('applyRefInput');
const applyRefBtn = document.getElementById('applyRefBtn');
const applyMsg = document.getElementById('applyMsg');
const stylesList = document.getElementById('stylesList');
const inputEl = document.getElementById('input');
const statusHint = document.getElementById('statusHint');

/* ------------- State ------------- */
let currentUser = null; // firebase user object
let currentUid = null;
let currentUserData = null;

/* ------------- Utility functions ------------- */
function genRefCode(){
  // 6-char uppercase alphanumeric
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

async function ensureUserDoc(uid, email, name){
  const userRef = ref(db, 'users/' + uid);
  const snap = await get(userRef);
  if (!snap.exists()){
    // create user with default coins = 0, generate referral code
    const code = genRefCode();
    await set(userRef, {
      email: email || '',
      displayName: name || '',
      coins: 0,
      referralCode: code,
      referredUsers: {},
      bonusAwarded: false,
      referredBy: null
    });
    // add mapping for quick lookup
    await set(ref(db, 'refCodes/' + code), uid);
    return { coins:0, referralCode:code, referredUsers: {}, bonusAwarded:false, referredBy:null };
  } else {
    return snap.val();
  }
}

function showUserInfo(){
  if (!currentUserData) return;
  coinDisplay.textContent = (currentUserData.coins || 0);
  userNameEl.textContent = currentUserData.displayName || currentUser.email;
  myRefCodeEl.textContent = currentUserData.referralCode || 'â€”';
  copyRefBtn.style.display = 'inline-block';
  const count = currentUserData.referredUsers ? Object.keys(currentUserData.referredUsers).length : 0;
  referredCountEl.textContent = `Referred: ${count}`;
  statusHint.textContent = 'Logged in â€¢ Click a style to copy (cost 2 coins)';
}

async function refreshUserData(){
  if (!currentUid) return;
  const snap = await get(ref(db, 'users/' + currentUid));
  currentUserData = snap.exists() ? snap.val() : null;
  showUserInfo();
}

/* ------------- Auth handlers ------------- */
loginBtn.addEventListener('click', async ()=>{
  try{
    const res = await signInWithPopup(auth, provider);
    // user signed in -> onAuthStateChanged will run
  }catch(err){
    console.error('Login error', err);
    alert('Login failed: ' + (err.message||err));
  }
});

logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
});

/* Listen for auth changes */
onAuthStateChanged(auth, async (user) => {
  if (user){
    currentUser = user;
    currentUid = user.uid;
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    // ensure user entry exists in DB
    currentUserData = await ensureUserDoc(user.uid, user.email, user.displayName);
    await refreshUserData();
  } else {
    currentUser = null; currentUid = null; currentUserData = null;
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    coinDisplay.textContent = '0';
    userNameEl.textContent = '';
    myRefCodeEl.textContent = 'â€”';
    copyRefBtn.style.display = 'none';
    referredCountEl.textContent = '';
    statusHint.textContent = 'Login required â€¢ 2 coins per copy';
  }
});

/* ------------- Referral apply logic ------------- */
applyRefBtn.addEventListener('click', async ()=>{
  applyMsg.textContent = '';
  const code = (applyRefInput.value || '').trim().toUpperCase();
  if (!code) { applyMsg.textContent = 'Enter a code.'; return; }
  if (!currentUid){ applyMsg.textContent = 'Login first to apply referral.'; return; }

  try{
    const codeSnap = await get(ref(db, 'refCodes/' + code));
    if (!codeSnap.exists()){ applyMsg.textContent = 'Invalid code.'; return; }
    const referrerUid = codeSnap.val();
    if (referrerUid === currentUid){ applyMsg.textContent = 'Cannot use your own code.'; return; }

    // check if current user already has a referrer
    const myRefSnap = await get(ref(db, 'users/' + currentUid + '/referredBy'));
    if (myRefSnap.exists() && myRefSnap.val()){
      applyMsg.textContent = 'You already used a referral code.';
      return;
    }

    // Atomically add current user to referrer's referredUsers and add 10 coins to referrer
    const referrerRef = ref(db, 'users/' + referrerUid);
    await runTransaction(referrerRef, (current)=>{
      if (current === null) return current;
      if (!current.referredUsers) current.referredUsers = {};
      // if already referred by this uid (safety), don't double count
      if (current.referredUsers[currentUid]) return; // abort
      // add referral
      current.referredUsers[currentUid] = true;
      current.coins = (current.coins || 0) + 10;
      return current;
    });

    // set current user's referredBy
    await update(ref(db, 'users/' + currentUid), { referredBy: referrerUid });

    // after transaction, check referrer count for bonus awarding
    const refSnap = await get(ref(db, 'users/' + referrerUid));
    const refData = refSnap.exists() ? refSnap.val() : null;
    if (refData){
      const count = refData.referredUsers ? Object.keys(refData.referredUsers).length : 0;
      if (count >= 15 && !refData.bonusAwarded){
        // award 1000 coins and mark bonusAwarded true
        await update(ref(db, 'users/' + referrerUid), { coins: (refData.coins||0) + 1000, bonusAwarded: true });
      }
    }

    applyMsg.textContent = 'Referral applied successfully!';
    await refreshUserData();
  }catch(err){
    console.error(err);
    applyMsg.textContent = 'Failed to apply referral.';
  }
});

/* copy referral code */
copyRefBtn.addEventListener('click', ()=>{
  const code = myRefCodeEl.textContent || '';
  if (!code) return;
  navigator.clipboard.writeText(code).then(()=>{ copyRefBtn.textContent = 'Copied'; setTimeout(()=>copyRefBtn.textContent='Copy',900); });
});

/* ------------- Stylish text generator ------------- */

/* character maps for fancy styles */
const maps = {
  bold: {'a':'ð—®','b':'ð—¯','c':'ð—°','d':'ð—±','e':'ð—²','f':'ð—³','g':'ð—´','h':'ð—µ','i':'ð—¶','j':'ð—·','k':'ð—¸','l':'ð—¹','m':'ð—º','n':'ð—»','o':'ð—¼','p':'ð—½','q':'ð—¾','r':'ð—¿','s':'ð˜€','t':'ð˜','u':'ð˜‚','v':'ð˜ƒ','w':'ð˜„','x':'ð˜…','y':'ð˜†','z':'ð˜‡','A':'ð—”','B':'ð—•','C':'ð—–','D':'ð——','E':'ð—˜','F':'ð—™','G':'ð—š','H':'ð—›','I':'ð—œ','J':'ð—','K':'ð—ž','L':'ð—Ÿ','M':'ð— ','N':'ð—¡','O':'ð—¢','P':'ð—£','Q':'ð—¤','R':'ð—¥','S':'ð—¦','T':'ð—§','U':'ð—¨','V':'ð—©','W':'ð—ª','X':'ð—«','Y':'ð—¬','Z':'ð—­'},
  italic: {'a':'ð˜¢','b':'ð˜£','c':'ð˜¤','d':'ð˜¥','e':'ð˜¦','f':'ð˜§','g':'ð˜¨','h':'ð˜©','i':'ð˜ª','j':'ð˜«','k':'ð˜¬','l':'ð˜­','m':'ð˜®','n':'ð˜¯','o':'ð˜°','p':'ð˜±','q':'ð˜²','r':'ð˜³','s':'ð˜´','t':'ð˜µ','u':'ð˜¶','v':'ð˜·','w':'ð˜¸','x':'ð˜¹','y':'ð˜º','z':'ð˜»','A':'ð´','B':'ðµ','C':'ð¶','D':'ð·','E':'ð¸','F':'ð¹','G':'ðº','H':'ð»','I':'ð¼','J':'ð½','K':'ð¾','L':'ð¿','M':'ð‘€','N':'ð‘','O':'ð‘‚','P':'ð‘ƒ','Q':'ð‘„','R':'ð‘…','S':'ð‘†','T':'ð‘‡','U':'ð‘ˆ','V':'ð‘‰','W':'ð‘Š','X':'ð‘‹','Y':'ð‘Œ','Z':'ð‘'},
  smallCaps:{'a':'á´€','b':'Ê™','c':'á´„','d':'á´…','e':'á´‡','f':'êœ°','g':'É¢','h':'Êœ','i':'Éª','j':'á´Š','k':'á´‹','l':'ÊŸ','m':'á´','n':'É´','o':'á´','p':'á´˜','q':'Ç«','r':'Ê€','s':'s','t':'á´›','u':'á´œ','v':'á´ ','w':'á´¡','x':'x','y':'Ê','z':'á´¢'}
};

const emojiList = ['ðŸ”¥','âœ¨','ðŸ’«','ðŸ’–','ðŸŒ¸','â­','ðŸ’¥','ðŸŒŸ','â¤ï¸','ðŸ’Ž','ðŸ’€','ðŸŽ¯','ðŸŽ‰','ðŸ¥¶','âš¡','ðŸŒˆ','ðŸŒ»','ðŸ‰','ðŸ’š','ðŸ˜Ž'];

/* helper to map characters */
function mapChars(text,map){ return text.split('').map(c=>map[c]||c).join(''); }

/* real styles array (each returns transformed text using user input) */
const styleFns = [
  t=>t,
  t=>t.toUpperCase(),
  t=>t.toLowerCase(),
  t=>mapChars(t,maps.bold),
  t=>mapChars(t,maps.italic),
  t=>mapChars(t,maps.smallCaps),
  t=>t.split('').reverse().join(''),
  t=>t.split('').join(' '),
  t=>`â™¡ ${t} â™¡`,
  t=>`â€ ${t} â€`,
  t=>`â–‚â–ƒâ–…â–‡â–ˆ ${t} â–ˆâ–‡â–…â–ƒâ–‚`,
  t=>`(â€¢_â€¢) ${t} (â€¢_â€¢)`,
  t=>`Â¯\\_(ãƒ„)_/Â¯ ${t} Â¯\\_(ãƒ„)_/Â¯`,
  t=>`ðŒ„ð‹„ðŒ€ðŒŒðŒðŒ‹ðŒ„ ${t} ðŒ•ðŒ„ð‹„ðŒ•`,
  t=>`â–„ï¸»ãƒ‡ ${t} â•â•â•â”ä¸€`,
  t=>`â€Â·á°„Â· ${t} Â·á°„Â·â€`,
  t=>`â€ê—¥ï½žê—¥â€ ${t} â€ê—¥ï½žê—¥â€`,
  t=>`âœ¨ ${t} âœ¨`,
  t=>`ðŸ’– ${t} ðŸ’–`,
  t=>`ðŸŒ¸ ${t} ðŸŒ¸`,
  t=>`â­ ${t} â­`,
  t=>`ðŸ’¥ ${t} ðŸ’¥`,
  t=>`â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ ${t} â–ˆâ–‡â–†â–…â–„â–ƒâ–‚â–`,
  t=>`â€¢Â°â€¢.Â°â€¢ ${t} â€¢Â°â€¢.Â°â€¢`,
  t=>`ââ€â ${t} ââ€â`,
  t=>`â˜…å½¡ ${t} å½¡â˜…`,
  t=>`âœ¿âœ¾âœ¿ ${t} âœ¿âœ¾âœ¿`,
  t=>`â™¡âœ§ ${t} âœ§â™¡`,
  t=>`â™ªâ™« ${t} â™«â™ª`,
  // emoji wrappers (only start & end)
  ...emojiList.map(e=> t => `${e} ${t} ${e}`),
  // some more unique combos
  t=>`ðŸ„´ðŸ…‡ðŸ„°ðŸ„¼ðŸ„¿ðŸ„»ðŸ„´ ${t}`,
  t=>`á´±Ë£áµƒáµáµ–Ë¡áµ‰ áµ—áµ‰Ë£áµ— ${t}`,
  t=>`â’ºâ“§â“â“œâ“Ÿâ“›â“” â“£â“”â“§â“£ ${t}`,
  t=>`â‚‘â‚“â‚ð‘šð‘Ô¼â‚‘ ð‘¡â‚‘â‚“ð‘¡ ${t}`,
  t=>`EÌ·Í‘Ì¾Í Ì¤ ${t}` // small glitch-like
];

/* render style boxes */
function renderStyles(){
  stylesList.innerHTML = '';
  const val = inputEl.value || '';
  styleFns.forEach((fn, i)=>{
    const div = document.createElement('div');
    div.className = 'style';
    div.textContent = fn(val);
    // click handler: attempt copy with coin deduction
    div.addEventListener('click', async ()=>{
      if (!currentUid) { alert('Please login first to copy (2 coins).'); return; }
      try{
        // atomic deduct 2 coins
        const userRef = ref(db, 'users/' + currentUid + '/coins');
        const txnResult = await runTransaction(userRef, (cur)=>{
          if (cur === null) return 0; // safety
          if (cur >= 2) return cur - 2;
          return; // abort if insufficient
        });
        if (!txnResult.committed){
          alert('Not enough coins. Earn or get referral coins.');
          return;
        }
        // Copy to clipboard
        await navigator.clipboard.writeText(div.textContent);
        // show quick feedback
        div.style.background = 'linear-gradient(90deg,#10b981,#06b6d4)';
        setTimeout(()=>div.style.background = '', 700);
        // refresh local user data
        await refreshUserData();
      }catch(err){
        console.error('Copy/deduct failed', err);
        alert('Action failed. Try again.');
      }
    });
    stylesList.appendChild(div);
  });
}

/* live update */
inputEl.addEventListener('input', ()=> renderStyles());

/* refresh on login/changes */
async function refreshUserData(){
  if (!currentUid) return;
  const snap = await get(ref(db, 'users/' + currentUid));
  currentUserData = snap.exists() ? snap.val() : null;
  if (currentUserData){
    coinDisplay.textContent = currentUserData.coins || 0;
    userNameEl.textContent = currentUserData.displayName || currentUser.email;
    myRefCodeEl.textContent = currentUserData.referralCode || 'â€”';
    const count = currentUserData.referredUsers ? Object.keys(currentUserData.referredUsers).length : 0;
    referredCountEl.textContent = `Referred: ${count}`;
  }
}

/* initial render */
renderStyles();

</script>
</body>
</html>
